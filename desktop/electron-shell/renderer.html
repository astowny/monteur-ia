<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Monteur IA Shell</title>
    <style>
      *, *::before, *::after { box-sizing: border-box; }
      body { font-family: Arial, sans-serif; margin: 0; background: #0f172a; color: #f8fafc; }
      .app-header { padding: 16px 24px 0; }
      h1 { margin: 0 0 12px; font-size: 18px; }
      /* banner */
      #backend-banner { display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:8px; margin-bottom:0; font-size:13px; }
      #backend-banner.starting { background:#1e3a5f; color:#93c5fd; }
      #backend-banner.ok      { background:#14532d; color:#86efac; }
      #backend-banner.error   { background:#450a0a; color:#fca5a5; }
      .dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
      .dot.pulse { background:#60a5fa; animation:pulse 1.2s infinite; }
      .dot.green { background:#4ade80; }
      .dot.red   { background:#f87171; }
      @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }
      /* tabs */
      .tab-bar { display:flex; gap:4px; padding: 12px 24px 0; border-bottom: 1px solid #1e293b; }
      .tab-btn { background:none; border:none; color:#94a3b8; padding:8px 16px; cursor:pointer; font-size:14px; border-bottom:2px solid transparent; border-radius:4px 4px 0 0; }
      .tab-btn.active { color:#f8fafc; border-bottom-color:#2563eb; background:#1e293b; }
      .tab-btn:hover:not(.active) { color:#cbd5e1; background:#1e293b40; }
      .tab-content { display:none; padding: 20px 24px; max-width:820px; }
      .tab-content.active { display:block; }
      /* cards */
      .card { background: #1e293b; border-radius: 10px; padding: 16px; margin-bottom: 12px; }
      .card h3 { margin:0 0 12px; font-size:14px; color:#cbd5e1; }
      /* form */
      .row { display: grid; gap: 6px; margin-bottom: 12px; }
      label { font-size: 13px; color: #cbd5e1; }
      input, select { padding: 8px; border-radius: 8px; border: 1px solid #334155; background: #0b1220; color: #f8fafc; width: 100%; font-size:13px; }
      /* buttons */
      button { background: #2563eb; border: none; color: white; border-radius: 8px; padding: 9px 14px; cursor: pointer; font-size:13px; }
      button:disabled { background:#334155; color:#64748b; cursor:not-allowed; }
      button.success { background: #15803d; }
      .btn-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
      /* file picker */
      .file-row { display:flex; gap:8px; align-items:center; }
      .file-row input { flex:1; }
      .file-row button { white-space:nowrap; flex-shrink:0; }
      /* pipeline steps */
      .step { border-left: 3px solid #334155; padding-left: 14px; margin-bottom: 18px; }
      .step.done   { border-left-color: #4ade80; }
      .step.running { border-left-color: #60a5fa; }
      .step.error  { border-left-color: #f87171; }
      .step-title { font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #cbd5e1; }
      .step-result { font-size: 12px; color: #94a3b8; margin-top: 8px; background:#0b1220; border-radius:6px; padding:8px; max-height:160px; overflow-y:auto; white-space:pre-wrap; word-break:break-word; }
      /* export format */
      .format-grid { display:flex; gap:8px; }
      .format-btn { flex:1; padding:12px 8px; text-align:center; border-radius:8px; border:2px solid #334155; background:#0b1220; color:#94a3b8; cursor:pointer; font-size:13px; }
      .format-btn.active { border-color:#2563eb; color:#f8fafc; background:#1e3a5f; }
      /* misc */
      .muted { color: #94a3b8; font-size: 13px; }
      code { color: #93c5fd; font-size: 12px; word-break:break-all; }
      #warn-box { display:none; background:#78350f; color:#fde68a; border-radius:8px; padding:10px 12px; font-size:13px; margin-bottom:8px; }
      #export-log { font-size:11px; color:#94a3b8; background:#0b1220; border-radius:6px; padding:8px; max-height:140px; overflow-y:auto; font-family:monospace; white-space:pre-wrap; display:none; margin-bottom:8px; }
    </style>
  </head>
  <body>
    <div class="app-header">
      <h1>üé¨ Monteur IA</h1>
      <div id="backend-banner" class="starting">
        <div class="dot pulse" id="dot"></div>
        <span id="banner-text">‚è≥ D√©marrage du backend‚Ä¶</span>
      </div>
    </div>

    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('config')">‚öôÔ∏è Config</button>
      <button class="tab-btn" onclick="switchTab('analyse')">üîç Analyser</button>
      <button class="tab-btn" onclick="switchTab('export')">üì§ Exporter</button>
    </div>

    <!-- ===== ONGLET CONFIG ===== -->
    <div id="tab-config" class="tab-content active">
      <div class="card">
        <h3>Configuration runtime</h3>
        <div class="row">
          <label>Environnement</label>
          <select id="env">
            <option value="dev">dev</option>
            <option value="staging">staging</option>
            <option value="prod">prod</option>
          </select>
        </div>
        <div class="row">
          <label>Mode transcription</label>
          <select id="mode">
            <option value="local">local (Whisper CLI)</option>
            <option value="api">api (Whisper distant)</option>
            <option value="stub">stub (dev only)</option>
          </select>
        </div>
        <div class="row">
          <label>API Key <span class="muted">(obligatoire en prod ‚Äî cha√Æne secr√®te de ton choix)</span></label>
          <input id="apiKey" placeholder="ex: mon-token-secret-2024" />
        </div>
        <div class="row">
          <label>Whisper API URL (si mode api)</label>
          <input id="whisperUrl" placeholder="https://..." />
        </div>
        <div class="row">
          <label>Whisper API Key (si mode api)</label>
          <input id="whisperKey" placeholder="token" />
        </div>
        <div id="warn-box"></div>
        <button id="saveBtn">üíæ Sauvegarder et red√©marrer backend</button>
        <p class="muted" id="cfg-status"></p>
      </div>
      <div class="card">
        <p class="muted">Backend local : <code>http://127.0.0.1:8000</code></p>
      </div>
    </div>

    <!-- ===== ONGLET ANALYSER ===== -->
    <div id="tab-analyse" class="tab-content">
      <div class="card">
        <h3>Vid√©o source</h3>
        <div class="file-row">
          <input id="videoPath" placeholder="Chemin de la vid√©o‚Ä¶" readonly />
          <button onclick="pickVideo()">üìÇ Parcourir</button>
        </div>
      </div>
      <div class="card">
        <h3>Pipeline d'analyse</h3>
        <div class="step" id="step-project">
          <div class="step-title">1. M√©tadonn√©es du projet</div>
          <button onclick="runCreateProject()" id="btn-project">Analyser</button>
          <div class="step-result" id="res-project" style="display:none"></div>
        </div>
        <div class="step" id="step-transcribe">
          <div class="step-title">2. Transcription</div>
          <div class="btn-row">
            <select id="lang" style="width:auto">
              <option value="fr">Fran√ßais</option>
              <option value="en">English</option>
            </select>
            <button onclick="runTranscribe()" id="btn-transcribe">Transcrire</button>
          </div>
          <div class="step-result" id="res-transcribe" style="display:none"></div>
        </div>
        <div class="step" id="step-hooks">
          <div class="step-title">3. G√©n√©ration de hooks</div>
          <div class="btn-row">
            <select id="hookStyle" style="width:auto">
              <option value="generic">G√©n√©rique</option>
              <option value="business">Business</option>
              <option value="podcast">Podcast</option>
              <option value="story">Story</option>
            </select>
            <button onclick="runGenerateHooks()" id="btn-hooks">G√©n√©rer les hooks</button>
          </div>
          <div class="step-result" id="res-hooks" style="display:none"></div>
        </div>
      </div>
    </div>

    <!-- ===== ONGLET EXPORTER ===== -->
    <div id="tab-export" class="tab-content">
      <div class="card">
        <h3>Vid√©o source</h3>
        <div class="file-row">
          <input id="exportInput" placeholder="Chemin de la vid√©o source‚Ä¶" />
          <button onclick="pickExportInput()">üìÇ Parcourir</button>
        </div>
      </div>
      <div class="card">
        <h3>Format de sortie</h3>
        <div class="format-grid">
          <div class="format-btn active" data-ratio="9:16" onclick="selectFormat(this)">
            <div>üì±</div><div>9:16</div>
            <div class="muted" style="font-size:11px">TikTok / Reels</div>
          </div>
          <div class="format-btn" data-ratio="1:1" onclick="selectFormat(this)">
            <div>‚¨õ</div><div>1:1</div>
            <div class="muted" style="font-size:11px">Instagram</div>
          </div>
          <div class="format-btn" data-ratio="16:9" onclick="selectFormat(this)">
            <div>üñ•Ô∏è</div><div>16:9</div>
            <div class="muted" style="font-size:11px">YouTube</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Sous-titres</h3>
        <div class="row">
          <label>
            <input type="checkbox" id="addSubs" style="width:auto;margin-right:6px" onchange="toggleSubs()">
            Br√ªler les sous-titres dans la vid√©o
          </label>
        </div>
        <div id="subs-row" class="file-row" style="display:none">
          <input id="subtitlePath" placeholder="Fichier .srt / .ass‚Ä¶" />
          <button onclick="pickSubtitle()">üìÇ Sous-titres</button>
        </div>
      </div>
      <div class="card">
        <h3>Fichier de sortie</h3>
        <div class="file-row">
          <input id="exportOutput" placeholder="output.mp4‚Ä¶" />
          <button onclick="pickExportOutput()">üìÅ Enregistrer sous‚Ä¶</button>
        </div>
      </div>
      <div class="btn-row">
        <button onclick="prepareExport()" id="btn-prepare">üîß Pr√©parer la commande</button>
        <button onclick="runExport()" id="btn-export" class="success" disabled>‚ñ∂Ô∏è Lancer l'export</button>
      </div>
      <div class="card" id="export-cmd-card" style="display:none">
        <h3>Commande FFmpeg</h3>
        <code id="export-cmd-text"></code>
      </div>
      <div id="export-log"></div>
      <p class="muted" id="export-status"></p>
    </div>

    <script>
      // ===== TABS =====
      function switchTab(name) {
        const names = ['config', 'analyse', 'export'];
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', names[i] === name));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + name).classList.add('active');
      }

      // ===== BACKEND BANNER =====
      const banner = document.getElementById('backend-banner');
      const dot = document.getElementById('dot');
      const bannerTxt = document.getElementById('banner-text');

      function setStatus(ok, msg) {
        if (ok) { banner.className = 'ok'; dot.className = 'dot green'; bannerTxt.textContent = '‚úÖ Backend connect√© ‚Äî ' + msg; }
        else     { banner.className = 'error'; dot.className = 'dot red'; bannerTxt.textContent = '‚ùå Backend indisponible ‚Äî ' + msg; }
      }
      window.monteur.onBackendStatus((data) => setStatus(data.ok, data.ok ? 'http://127.0.0.1:8000' : (data.error || data.status)));

      // ===== BACKEND FETCH =====
      async function backendFetch(method, path, body) {
        const conf = await window.monteur.getConfig();
        const apiKey = conf.MONTEUR_API_KEY || '';
        const opts = { method, headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey } };
        if (body) opts.body = JSON.stringify(body);
        const res = await fetch('http://127.0.0.1:8000' + path, opts);
        if (!res.ok) { const e = await res.json().catch(() => ({ detail: res.statusText })); throw new Error(e.detail || res.statusText); }
        return res.json();
      }

      // ===== CONFIG TAB =====
      async function initConfig() {
        const conf = await window.monteur.getConfig();
        document.getElementById('env').value = conf.MONTEUR_ENV || 'dev';
        document.getElementById('mode').value = conf.MONTEUR_TRANSCRIBE_MODE || 'stub';
        document.getElementById('apiKey').value = conf.MONTEUR_API_KEY || '';
        document.getElementById('whisperUrl').value = conf.WHISPER_API_URL || '';
        document.getElementById('whisperKey').value = conf.WHISPER_API_KEY || '';
      }

      function validate(env, mode, apiKey) {
        const warn = document.getElementById('warn-box');
        const errors = [];
        if (env === 'prod' && mode === 'stub') errors.push('‚ö†Ô∏è Mode "stub" interdit en prod.');
        if (env === 'prod' && !apiKey.trim()) errors.push('‚ö†Ô∏è API Key obligatoire en prod.');
        if (mode === 'api' && !document.getElementById('whisperUrl').value.trim()) errors.push('‚ö†Ô∏è Whisper API URL requise en mode api.');
        if (errors.length) { warn.style.display = 'block'; warn.textContent = errors.join(' '); return false; }
        warn.style.display = 'none'; return true;
      }

      document.getElementById('saveBtn').addEventListener('click', async () => {
        const conf = await window.monteur.getConfig();
        conf.MONTEUR_ENV = document.getElementById('env').value;
        conf.MONTEUR_TRANSCRIBE_MODE = document.getElementById('mode').value;
        conf.MONTEUR_API_KEY = document.getElementById('apiKey').value;
        conf.WHISPER_API_URL = document.getElementById('whisperUrl').value;
        conf.WHISPER_API_KEY = document.getElementById('whisperKey').value;
        if (!validate(conf.MONTEUR_ENV, conf.MONTEUR_TRANSCRIBE_MODE, conf.MONTEUR_API_KEY)) return;
        const st = document.getElementById('cfg-status');
        st.textContent = 'Sauvegarde en cours‚Ä¶';
        try {
          const result = await window.monteur.saveConfig(conf);
          st.textContent = result.ok ? '‚úÖ Configuration appliqu√©e.' : `‚ùå Backend non disponible (${result.status})`;
        } catch (err) { st.textContent = `Erreur: ${err.message || err}`; }
      });

      // ===== ANALYSE TAB =====
      let transcript = [];

      async function pickVideo() {
        const p = await window.monteur.openVideo();
        if (!p) return;
        document.getElementById('videoPath').value = p;
        document.getElementById('exportInput').value = p;
        ['step-project','step-transcribe','step-hooks'].forEach(id => document.getElementById(id).className = 'step');
        ['res-project','res-transcribe','res-hooks'].forEach(id => { const el = document.getElementById(id); el.style.display='none'; el.textContent=''; });
        transcript = [];
      }

      function stepState(id, state) { document.getElementById(id).className = 'step ' + state; }

      async function runCreateProject() {
        const p = document.getElementById('videoPath').value;
        if (!p) return alert('S√©lectionne une vid√©o d\'abord.');
        const btn = document.getElementById('btn-project');
        btn.disabled = true; btn.textContent = '‚è≥‚Ä¶';
        stepState('step-project', 'running');
        const res = document.getElementById('res-project');
        try {
          const data = await backendFetch('POST', '/project/create', { video_path: p, project_id: null });
          const m = data.metadata || {};
          res.textContent = `Projet : ${data.project_id}\nFichier : ${m.filename || p}\nTaille : ${m.file_size_mb ? m.file_size_mb + ' Mo' : '‚Äî'}`;
          res.style.display = 'block'; stepState('step-project', 'done');
        } catch (e) { res.textContent = '‚ùå ' + e.message; res.style.display = 'block'; stepState('step-project', 'error'); }
        btn.disabled = false; btn.textContent = 'Analyser';
      }

      async function runTranscribe() {
        const p = document.getElementById('videoPath').value;
        if (!p) return alert('S√©lectionne une vid√©o d\'abord.');
        const btn = document.getElementById('btn-transcribe');
        btn.disabled = true; btn.textContent = '‚è≥ Transcription‚Ä¶';
        stepState('step-transcribe', 'running');
        const res = document.getElementById('res-transcribe');
        try {
          const data = await backendFetch('POST', '/transcribe', { video_path: p, language: document.getElementById('lang').value });
          transcript = data.segments || [];
          const preview = transcript.slice(0, 5).map(s => `[${s.start.toFixed(1)}s] ${s.text}`).join('\n');
          res.textContent = `${transcript.length} segment(s)\n\n${preview}${transcript.length > 5 ? '\n‚Ä¶' : ''}`;
          res.style.display = 'block'; stepState('step-transcribe', 'done');
        } catch (e) { res.textContent = '‚ùå ' + e.message; res.style.display = 'block'; stepState('step-transcribe', 'error'); }
        btn.disabled = false; btn.textContent = 'Transcrire';
      }

      async function runGenerateHooks() {
        if (!transcript.length) return alert('Lance la transcription d\'abord.');
        const btn = document.getElementById('btn-hooks');
        btn.disabled = true; btn.textContent = '‚è≥ G√©n√©ration‚Ä¶';
        stepState('step-hooks', 'running');
        const res = document.getElementById('res-hooks');
        try {
          const data = await backendFetch('POST', '/generate-hooks', { transcript, style: document.getElementById('hookStyle').value, limit: 5 });
          res.textContent = (data.hooks || []).map((h, i) => `${i+1}. ${h}`).join('\n\n');
          res.style.display = 'block'; stepState('step-hooks', 'done');
        } catch (e) { res.textContent = '‚ùå ' + e.message; res.style.display = 'block'; stepState('step-hooks', 'error'); }
        btn.disabled = false; btn.textContent = 'G√©n√©rer les hooks';
      }

      // ===== EXPORT TAB =====
      let selectedRatio = '9:16';
      let exportCommand = null;

      function selectFormat(el) {
        document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active'); selectedRatio = el.dataset.ratio;
      }
      function toggleSubs() { document.getElementById('subs-row').style.display = document.getElementById('addSubs').checked ? 'flex' : 'none'; }
      async function pickExportInput() { const p = await window.monteur.openVideo(); if (p) document.getElementById('exportInput').value = p; }
      async function pickSubtitle()    { const p = await window.monteur.openSubtitle(); if (p) document.getElementById('subtitlePath').value = p; }
      async function pickExportOutput() {
        const inp = document.getElementById('exportInput').value;
        const def = inp ? inp.replace(/\.[^.]+$/, `_${selectedRatio.replace(':','-')}.mp4`) : 'output.mp4';
        const p = await window.monteur.saveAs(def);
        if (p) document.getElementById('exportOutput').value = p;
      }

      async function prepareExport() {
        const input = document.getElementById('exportInput').value;
        const output = document.getElementById('exportOutput').value;
        if (!input || !output) return alert('Renseigne la vid√©o source et le fichier de sortie.');
        try {
          const data = await backendFetch('POST', '/pipeline/export/prepare', {
            input_path: input, output_path: output, aspect_ratio: selectedRatio,
            add_subtitles: document.getElementById('addSubs').checked,
            subtitle_path: document.getElementById('subtitlePath').value || '',
          });
          exportCommand = data.command;
          document.getElementById('export-cmd-text').textContent = data.command.join(' ');
          document.getElementById('export-cmd-card').style.display = 'block';
          document.getElementById('btn-export').disabled = false;
          document.getElementById('export-status').textContent = '‚úÖ Commande pr√™te. Lance l\'export quand tu veux.';
        } catch (e) { document.getElementById('export-status').textContent = '‚ùå ' + e.message; }
      }

      async function runExport() {
        if (!exportCommand) return;
        const btn = document.getElementById('btn-export');
        btn.disabled = true; btn.textContent = '‚è≥ Export en cours‚Ä¶';
        const log = document.getElementById('export-log');
        log.style.display = 'block'; log.textContent = '';
        window.monteur.onExportProgress((line) => { log.textContent += line; log.scrollTop = log.scrollHeight; });
        try {
          const result = await window.monteur.runExport(exportCommand);
          document.getElementById('export-status').textContent = result.ok ? '‚úÖ Export termin√© !' : '‚ùå Erreur FFmpeg (voir log ci-dessus)';
        } catch (e) { document.getElementById('export-status').textContent = '‚ùå ' + e.message; }
        btn.disabled = false; btn.textContent = '‚ñ∂Ô∏è Lancer l\'export';
      }

      // ===== INIT =====
      initConfig();
    </script>
  </body>
</html>
